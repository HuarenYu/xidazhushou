<!DOCTYPE HTML>
<html>
    <head>
        <title>camera</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    </head>
    <body>
        <video id="video" autoplay></video>
        <canvas id="canvas"></canvas>
        <button id="openCameraBtn">Open camera</button>
        <button id="captureBtn">Capture</button>
        <button id="uploadBtn">Upload to my Dropbox</button>
        <div id="uploadState"></div>
        <script type="text/javascript">
            var queryString = location.href.indexOf('#') ? 
                              location.href.substring(location.href.indexOf('#') + 1)
                              : '';
            var queryParams = parseQueryString(queryString);
            var token = queryParams['access_token'];
            if (!token) {
                var result = confirm('Login use your dropbox account?');
                if (result) {
                    window.location.href = 'https://www.dropbox.'
                                     + 'com/1/oauth2/authorize?'
                                     + 'response_type=token&client_id='
                                     + '6zfho04r89gxu0c'
                                     + '&redirect_uri=https://huarenyu.github.'
                                     + 'io/xidazhushou/camera.html';
                }
                
            }
            navigator.getUserMedia = navigator.getUserMedia ||
                                     navigator.webkitGetUserMedia ||
                                     navigator.mozGetUserMedia ||
                                     navigator.msGetUserMedia;
            var video = document.querySelector('#video');
            var openCameraBtn = document.querySelector('#openCameraBtn');
            var captureBtn = document.querySelector('#captureBtn');
            var uploadBtn = document.querySelector('#uploadBtn');
            var canvas = document.querySelector('#canvas');
            var uploadState = document.querySelector('#uploadState');
            canvas.height = 240;
            canvas.width = 320;
            var ctx = canvas.getContext('2d');
            var uploadUrl = 'https://api-content.dropbox.com/1/files_put/dropbox/';
            var imgName = '';
            var imgBase64Str = '';

            openCameraBtn.addEventListener('click', function(e) {
                openCamera();
            });
            captureBtn.addEventListener('click', function(e) {
                capture();
            });
            uploadBtn.addEventListener('click', function(e) {
                upload();
            });

            var capture = function() {
                ctx.drawImage(video, 0, 0);
                var imgData = canvas.toDataURL('image/png');
                imgBase64Str = imgData.substr(22);
            };
            var openCamera = function() {
                navigator.getUserMedia({video: {mandatory: {
                                                  maxWidth: 320,
                                                  maxHeight: 240
                                                }}},
                    function(stream) {
                        video.src = window.URL.createObjectURL(stream);
                    },
                    function(error) {
                        alert('Open camera error.');
                });
            };
            var upload = function() {
                if (!imgBase64Str) {
                    alert('Please capture.');
                    return;
                }
                uploadState.innerHTML = 'uploading...';
                var ajax = new XMLHttpRequest();
                var date = new Date();
                imgName = date.getTime() + '.png';
                ajax.open('PUT', uploadUrl + imgName, true);
                ajax.setRequestHeader('Authorization', ' Bearer ' + token);
                ajax.setRequestHeader('Content-type', 'image/png');
                ajax.send(base64DecToArr(imgBase64Str));
                ajax.onreadystatechange = function() {
                    if (ajax.readyState === 4) {
                        if (ajax.status === 200) {
                            uploadState.innerHTML = ajax.responseText;
                            alert('A picture named ' + imgName + ' was saved to your dropbox root directory.');
                        } else {
                            uploadState.innerHTML = ajax.responseText;
                            alert('Upload encounter an error.');
                        }
                    }
                }
            };
            function parseQueryString(qs) {
                var params = {};
                if (!qs) return params;
                var paramPairs = qs.split('&');
                paramPairs.forEach(function(item, index) {
                    var nameValue = item.split('=');
                    if (nameValue[0]) {
                        params[nameValue[0]] = nameValue[1];
                    }
                });
                return params;
            }
            //This two functions is reference from MDN base64 string convert to 
            //ArrayBuffere.
            function b64ToUint6 (nChr) {
              return nChr > 64 && nChr < 91 ?
                  nChr - 65
                : nChr > 96 && nChr < 123 ?
                  nChr - 71
                : nChr > 47 && nChr < 58 ?
                  nChr + 4
                : nChr === 43 ?
                  62
                : nChr === 47 ?
                  63
                :
                  0;

            }
            function base64DecToArr (sBase64, nBlocksSize) {
                var sB64Enc = sBase64.replace(/[^A-Za-z0-9\+\/]/g, ""), 
                    nInLen = sB64Enc.length,
                    nOutLen = nBlocksSize ? Math.ceil((nInLen * 3 + 1 >> 2) / nBlocksSize) * nBlocksSize : nInLen * 3 + 1 >> 2, 
                    taBytes = new Uint8Array(nOutLen);

              for (var nMod3, nMod4, nUint24 = 0, nOutIdx = 0, nInIdx = 0; nInIdx < nInLen; nInIdx++) {
                nMod4 = nInIdx & 3;
                nUint24 |= b64ToUint6(sB64Enc.charCodeAt(nInIdx)) << 18 - 6 * nMod4;
                if (nMod4 === 3 || nInLen - nInIdx === 1) {
                  for (nMod3 = 0; nMod3 < 3 && nOutIdx < nOutLen; nMod3++, nOutIdx++) {
                    taBytes[nOutIdx] = nUint24 >>> (16 >>> nMod3 & 24) & 255;
                  }
                  nUint24 = 0;

                }
              }
              return taBytes;
            }

            
        </script>
    </body>
</html>